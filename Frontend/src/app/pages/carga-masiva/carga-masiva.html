<section id="carga" class="content-section active-section">
    <h2 class="text-3xl font-bold text-white mb-6"><i class="fas fa-cloud-upload-alt text-accent-purple mr-2"></i> Carga Masiva de Datos</h2>

    <div *ngIf="errorMessage" class="bg-red-900/50 text-red-300 p-4 rounded-lg mb-4 flex justify-between items-center">
        <p><i class="fas fa-exclamation-triangle mr-2"></i> {{ errorMessage }}</p>
        <button (click)="errorMessage = null" class="text-red-300 hover:text-white"><i class="fas fa-times"></i></button>
    </div>
    <div *ngIf="successMessage" class="bg-green-900/50 text-green-300 p-4 rounded-lg mb-4 flex justify-between items-center">
        <p><i class="fas fa-check-circle mr-2"></i> {{ successMessage }}</p>
        <button (click)="successMessage = null" class="text-green-300 hover:text-white"><i class="fas fa-times"></i></button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-card-dark p-8 rounded-xl shadow-2xl hover:shadow-purple-900/40 transition duration-300">
            <h3 class="text-xl font-semibold text-white mb-6 border-b border-gray-700 pb-3">Zona de Archivo y Acciones</h3>
            
            <div class="flex gap-6">
                
                <input #fileInput type="file" id="file-upload" accept=".csv" class="hidden" 
                       (change)="handleFileInput($event)">

                <div class="flex-1 text-center border-4 border-dashed rounded-xl p-12 transition duration-300 group"
                     [ngClass]="{'border-accent-purple bg-primary-dark/50 hover:bg-primary-dark/70 cursor-pointer': !uploading && !dataLoaded, 'border-gray-500 bg-gray-900/50 cursor-not-allowed': uploading || dataLoaded}"
                     (click)="!uploading && !dataLoaded && fileInput.click()">
                    
                    <i class="fas fa-box-open text-6xl text-accent-purple mb-4 group-hover:scale-110 transition duration-300"></i>
                    <p *ngIf="!fileToUpload" class="text-lg font-semibold text-white">Arrastra y suelta tu archivo aquí</p>
                    <p *ngIf="fileToUpload" class="text-lg font-semibold text-white truncate">{{ fileToUpload.name }}</p>
                    <p class="text-sm text-gray-400 mb-6">Formatos: CSV. Máx: 16MB</p>
                            
                    <div class="flex justify-center gap-3">
                        <button (click)="$event.stopPropagation(); fileInput.click()"
                                [disabled]="uploading"
                                class="py-2 px-6 rounded-lg bg-accent-purple hover:bg-purple-800 font-medium transition duration-200">
                            {{ fileToUpload && dataLoaded ? 'Cambiar Archivo' : 'Seleccionar Archivo' }}
                        </button>
                        
                        <button *ngIf="fileToUpload && !dataLoaded"
                                (click)="$event.stopPropagation(); uploadFile()"
                                [disabled]="uploading"
                                class="py-2 px-6 rounded-lg bg-green-600 hover:bg-green-700 font-medium transition duration-200"
                                [class.opacity-50]="uploading">
                            <i class="fas fa-upload mr-2"></i> {{ uploading ? 'Subiendo...' : 'Subir a Servidor' }}
                        </button>

                        <button *ngIf="fileToUpload && dataLoaded"
                                (click)="$event.stopPropagation(); resetResults();"
                                [disabled]="uploading"
                                class="py-2 px-6 rounded-lg bg-red-600 hover:bg-red-700 font-medium transition duration-200">
                            <i class="fas fa-trash mr-2"></i> Borrar Archivo
                        </button>
                    </div>
                </div>
                
                <div class="w-1/3 bg-primary-dark p-6 rounded-xl border border-gray-700 flex flex-col justify-between">
                    <div>
                        <h4 class="text-accent-cyan font-bold mb-4">Estado de la Tarea</h4>
                        
                        <div class="text-center mb-6">
                            <span class="text-xl font-extrabold text-white block">{{ currentStatus }}</span>
                            <div class="mt-3">
                                <span [ngClass]="{'text-green-400': dataLoaded, 'text-gray-500': !dataLoaded}"><i class="fas fa-database mr-1"></i> Datos Cargados</span>
                                <span class="mx-2 text-gray-700">|</span>
                                <span [ngClass]="{'text-blue-400': cleanSummary, 'text-gray-500': !cleanSummary}"><i class="fas fa-broom mr-1"></i> Datos Limpios</span>
                                <span class="mx-2 text-gray-700">|</span>
                                <span [ngClass]="{'text-purple-400': trainingMetrics, 'text-gray-500': !trainingMetrics}"><i class="fas fa-brain mr-1"></i> Modelo Entrenado</span>
                            </div>
                        </div>

                        <div *ngIf="uploadResult" class="text-sm text-gray-400">
                            <p>Archivo: <span class="text-white">{{ uploadResult.filename }}</span></p>
                            <p>Filas Originales: {{ uploadResult.info.total_rows }}</p>
                            <p>Columnas: {{ uploadResult.info.total_columns }}</p>
                            <p [ngClass]="{'text-red-400 font-bold': getTotalMissingValues() > 0}">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Valores Faltantes: {{ getTotalMissingValues() }}
                            </p>
                        </div>
                        <div *ngIf="cleanSummary" class="text-sm text-gray-400 mt-3">
                            <p>Filas Limpias: {{ cleanSummary.cleaned_info.total_rows }}</p>
                            <p>Filas Removidas: {{ cleanSummary.summary.rows_removed }}</p>
                            <p>Valores Faltantes Imputados: {{ cleanSummary.summary.imputed_count }}</p>
                        </div>
                        <div *ngIf="trainingMetrics" class="text-sm text-gray-400 mt-3">
                            <p>Accuracy: <span class="font-bold text-accent-cyan">{{ trainingMetrics.accuracy | number:'1.3-3' }}</span></p>
                            <p>F1-Score: <span class="font-bold text-accent-cyan">{{ trainingMetrics.f1_score | number:'1.3-3' }}</span></p>
                        </div>
                    </div>

                    <div class="space-y-3 mt-6">
                        <button (click)="cleanData()"
                                [disabled]="!dataLoaded || cleaning || !!cleanSummary"
                                class="w-full py-3 rounded-lg font-medium transition duration-200 flex items-center justify-center"
                                [ngClass]="{'bg-blue-600 hover:bg-blue-500': dataLoaded && !cleanSummary, 'bg-gray-600': !dataLoaded || !!cleanSummary || cleaning, 'opacity-70': cleaning}">
                            <i class="fas fa-broom mr-2"></i> {{ cleaning ? 'Limpiando...' : 'Limpiar Datos' }}
                        </button>
                        
                        <button (click)="trainModel()"
                                [disabled]="!cleanSummary || training || !!trainingMetrics"
                                class="w-full py-3 rounded-lg font-medium transition duration-200 flex items-center justify-center shadow-lg"
                                [ngClass]="{'bg-accent-purple hover:bg-purple-800 shadow-purple-900/50': !!cleanSummary && !trainingMetrics, 'bg-gray-600': !cleanSummary || !!trainingMetrics || training, 'opacity-70': training}">
                            <i class="fas fa-brain mr-2"></i> {{ training ? 'Entrenando...' : 'Entrenar Modelo' }}
                        </button>
                        
                        <button (click)="resetSystem()"
                                [disabled]="uploading || cleaning || training"
                                class="w-full py-1 text-sm rounded-lg font-medium transition duration-200 flex items-center justify-center bg-red-700 hover:bg-red-600">
                            <i class="fas fa-undo mr-2"></i> Reiniciar Sistema (Borrar Datos y Archivos)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-card-dark p-6 rounded-xl shadow-xl">
            <h3 class="text-xl font-semibold text-white mb-4"><i class="fas fa-history text-accent-cyan mr-2"></i> Preview de Datos</h3>
            
            <ng-container *ngIf="uploadResult as result">
                <div *ngIf="result.preview && result.preview.length" class="overflow-x-auto max-h-96">
                    <p class="text-xs text-gray-400 mb-2">Primeras {{ result.preview.length }} filas de los datos cargados.</p>
                    
                    <table class="min-w-full table-auto text-xs text-left text-gray-300">
                        <thead class="text-xs text-gray-100 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="px-2 py-3">#</th>
                                <th scope="col" class="px-2 py-3" *ngFor="let column of result.info.columns">
                                    {{ column }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700" *ngFor="let row of result.preview; let i = index">
                                <th scope="row" class="px-2 py-2 font-medium text-white whitespace-nowrap">{{ i + 1 }}</th>
                                <td class="px-2 py-2" *ngFor="let column of result.info.columns">
                                    {{ row[column] }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <p *ngIf="!result.preview || result.preview.length === 0" class="text-gray-500 text-center py-4">
                    Datos cargados, pero la vista previa está vacía o no disponible.
                </p>

            </ng-container>
            
            <p *ngIf="!uploadResult" class="text-gray-500 text-center py-4">Sube un archivo para ver la vista previa.</p>
        </div>

    </div>
</section>